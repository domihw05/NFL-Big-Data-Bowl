---
title: "The Impact of Play Clock Timing on NFL Play Outcomes"
author: "Dominic Hoar-Weiler, Nathan Yao, and Justin Fung"
date: "January 6, 2025"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
geometry: a4paper
fontsize: 12pt
linestretch: 1.5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#Click to clear environment
rm(list = ls())
```

# Introduction
One moment etched in the hearts of Minnesota Vikings fans is the 2018 NFL 
playoff game against the New Orleans Saints. With just 5 seconds left on the 
play clock, Case Keenum launches a high, spiraling pass to Stefon Diggs, who 
streaks down the right sideline. The crowd erupts as Diggs makes the catch and 
sprints into the end zone, completing one of the most iconic touchdowns in NFL 
history. This unforgettable play, now famously known as the Minneapolis Miracle, 
highlights the critical role of the play clock. In football, the play clock 
isn’t just a countdown, it’s a pressure cooker that influences decision making, 
timing, and ultimately, the outcome of a play.

The focus of this research is to examine how the play clock at the snap, along 
with other variables, impacts play success. By investigating this relationship, 
we aim to develop a predictive model that forecasts play outcomes based on the 
timing of the snap. 


```{r, include = FALSE}
# Increase memory size (Windows only)
memory.limit(size = 64000)  # Adjust as needed

library(tidyverse)
player_raw_data <- read_csv("players.csv")
plays_raw_data <- read_csv("plays.csv")
games_raw_data <- read_csv("games.csv")
# List all files matching the pattern "week" (e.g., "tracking_week_1.csv")
files <- list.files(pattern = "week", full.names = TRUE)
tracking_list <- list()

```
```{r, include = FALSE}
for (file in files) {
  tracking <- read_csv(file)
  tracking <- tracking |>
    mutate(
    # make all plays go from left to right
    x = ifelse(playDirection == "left", 120 - x, x),
    y = ifelse(playDirection == "left", 160 / 3 - y, y),
    # flip player direction and orientation
    dir = ifelse(playDirection == "left", dir + 180, dir),
    dir = ifelse(dir > 360, dir - 360, dir),
    o = ifelse(playDirection == "left", o + 180, o),
    o = ifelse(o > 360, o - 360, o)
    )
  tracking_list[[file]] <- tracking
}
```

# Exploratory Analysis:

## Background and Variables
We analyze multiple datasets, including player statistics, play-by-play data, 
and game metadata, sourced from the 2024–2025 NFL season as part of the Big Data
Bowl competition. 

The data that was used for most of analysis came from the “plays.csv” data set, 
A number of exploratory variables were recorded:\
- yardsToGo:Distance needed for a first down (numeric)\
- gameClock:Time on clock of play (MM:SS)\
- offenseFormation:Formation used by possession team (text)\
- playClockAtSnap:What the play clock value was at time of snap (numeric)\
- passResult:Dropback outcome of the play (C: Complete pass, I: Incomplete pass
, S: Quarterback sack, IN: Intercepted pass, R: Scramble, text)\
- yardsGained:Net yards gained by the offense, including penalty yardage (numeric) \

and many more. 

## Some Exploratory Data Analysis with Play Clock at Snap

### Distributions of Important Variables
There were a variety of possible variables that along with playClockAtSnap
that would be important in our analysis. This section explores distributions 
of important variables and the relationships between them. Below are the 
different variables and their distributions that we looked at in our analysis: 


passResult (Categorical):
We have filtered out the NA values which indicate non-pass plays, as we are 
only trying to explore passing plays. (C: Complete pass, I: Incomplete pass
, S: Quarterback sack, IN: Intercepted pass, R: Scramble)
```{r}
plays_filtered <- plays_raw_data %>%
  filter(!is.na(passResult))

ggplot(plays_filtered, aes(x = passResult)) +
  geom_bar(fill = "steelblue") +
  labs(
    title = "Distribution of Pass Results",
    x = "Pass Result",
    y = "Count"
  ) +
  theme_minimal()
```
The most frequent pass result is C (completed pass). This makes sense as a lot
of the time the quarterback will complete his pass to a receiver. The second 
most frequent category is I (incomplete pass), which is also expected. After
that, the next most frequent categories are in order as follows: S (quarterback
sack), R (scramble--quarterback improvised run), and IN (intercepted pass).

yardsGained (Quantitative):
```{r}
ggplot(plays_filtered, aes(x = yardsGained)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "black") +
  labs(
    title = "Distribution of Yards Gained",
    x = "Yards Gained",
    y = "Frequency"
  ) +
  theme_minimal()
```
Yards gained looks like it is slightly normally distributed and is right skewed.
The overwhelming majority of plays result in 0 yards gained according to the
graphic. This makes sense as all incomplete passes result in 0 yards gained, 
assuming no penalties.


yardsToGo (Quantitative):
```{r}
ggplot(plays_filtered, aes(x = yardsToGo)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black") +
  labs(
    title = "Distribution of Yards to Go",
    x = "Yards to Go",
    y = "Frequency"
  ) +
  theme_minimal()
```
Yards to Go seems to be slightly normally distributed with a significant outlier
with the vast majority of plays being at 10 yards to go. This makes sense as
every play defaults to 10 yards to go for a first down. The distribution is
slightly right skewed with more plays with less than 10 yards to go.


playClockAtSnap (Quantitative):
For the play clock at snap, we split the quantitative variable into 3 
buckets: High (>=15 seconds), Medium (5–15 seconds), and Low (<5 seconds). These 
thresholds were chosen to reflect typical game scenarios: early snaps, moderate 
decision-making time, and rushed snaps. In this case, we created a new variable
called playClockCategory which is a categorical variable that has counts of 
plays in each of the 3 categories. Below is the distribution:

```{r}
plays_raw_data <- plays_raw_data %>%
  mutate(playClockCategory = 
           case_when(playClockAtSnap >= 15 ~ "playClock More Than 15s",               
                      playClockAtSnap >= 5 & 
                      playClockAtSnap < 15 ~ "playClock Between 5s and 15s", 
                      playClockAtSnap < 5 ~ "playClock Less Than 5s",               
    )
  )

plays_filtered <- plays_raw_data %>%
  filter(!is.na(playClockCategory), !is.na(passResult))

ggplot(plays_filtered, aes(x = playClockCategory)) +
  geom_bar(fill = "steelblue", color = "black") +
  labs(
    title = "Frequency of Play Clock Categories",
    x = "Play Clock Category",
    y = "Count"
  ) +
  theme_minimal()
```
Based on the above graph, we see that the vast majority of the time the ball
is snapped in the moderate play clock zone with between 5 and 15 seconds left
on the play clock. This makes sense as most of the time teams want to make sure
they have time to huddle up, relay the play to everyone and get set before
snapping the ball. The second most frequent category is when the play clock is
greater than 15 seconds. This category expresses when teams may be in a hurry-up
offense where they might need to get down the field quicker or just want to get
the defense on their heels. The least frequent category is when the play clock
is less than 5 seconds. This category includes plays where teams may take a 
little longer to get set. This can be for a variety of reasons; teams may be
sending players in motion before the snap or the quarterback may be making
audibles or adjustments at the line of scrimmage. The significant parts that
are relevant in the analysis below will be the more extreme buckets of less than
5 seconds and more than 15 seconds. 


### Relationships Between Variables
Before building predictive models, it’s important to investigate potential 
relationships between variables that could impact play outcomes. In this 
section, we focus on the playClockAtSnap variable, which records the play clock 
value at the time of the snap, and explore its relationship with pass results 
and yards gained during a play.

The play clock is a critical element in football, as it dictates when a play 
must begin. A snap taken with a lower play clock may suggest hurried decision 
making, potentially leading to rushed plays or errors. 

Below are some visuals and descriptions exploring the relationships between
variables: 

```{r}

ggplot(plays_filtered, aes(x = playClockCategory, fill = passResult)) +
  geom_bar(position = "fill") +
  labs(
    title = "Play Outcomes by Play Clock Category",
    x = "Play Clock Category",
    y = "Proportion",
    fill = "Pass Result"
  ) +
  theme_minimal()
```
We can see that when the playClock is less than or equal to 
5s (lower), there is a more varied distribution of pass results, including 
incomplete passes, sacks, and interceptions. 
On the other hand (higher), it looks like high play clock snaps tend to result in more 
complete passes, potentially indicating that the defense had less time to 
organize and execute a well prepared play.

```{r}
contingency_table <- table(plays_filtered$playClockCategory, 
                           plays_filtered$passResult)

chi_sq_test <- chisq.test(contingency_table)
print(chi_sq_test)
```
And we can see here, the playClock is indeed statistically significant with a
value of 0.0002549 < 0.05. The next step would be to find a model to potentially 
predict results.


```{r}

ggplot(plays_filtered, aes(x = playClockCategory, y = yardsGained, 
                           fill = playClockCategory)) +
  geom_boxplot() +
  labs(
    title = "Yards Gained by Play Clock Category",
    x = "Play Clock Category",
    y = "Yards Gained"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```
We also investigated the relationship that the play block at snap might have
with the yards gained that play. However, as we can see the above visualization, 
there is no clear correlation between the two. That being said, we do notice
that there seems to be slightly more variation in yards gained when the play
clock is less than 15 seconds compared to when it is more than 15 seconds.

```{r}
# Summarize yardsGained by playClockCategory
plays_summary <- plays_filtered |>
  group_by(playClockCategory) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    sd_yards = sd(yardsGained, na.rm = TRUE),  # Standard deviation
    min_yards = min(yardsGained, na.rm = TRUE),
    max_yards = max(yardsGained, na.rm = TRUE),
    n = n()
  )
print(plays_summary)
```

This exploration confirms what we saw above, slightly more variation and range
of yards gained when the play clock is lower.

Further exploration of how the play clock affects other variables yields the
following heat map. This heat map illustrates the play success rate based on 
the play clock and yards to go during that play. 

```{r}
heatmap_data <- plays_filtered %>%
  filter(!is.na(playClockCategory), !is.na(yardsToGo), yardsToGo >= 0, yardsToGo <= 30) %>%  
  mutate(
    yardsToGoBucket = cut(
      yardsToGo, breaks = c(0, 5, 10, 15, 20, 30),
      right = FALSE, include.lowest = TRUE
    )
  ) %>%
  group_by(playClockCategory, yardsToGoBucket) %>%
  summarize(success_rate = mean(passResult == "C", na.rm = TRUE), .groups = "drop")

ggplot(heatmap_data, aes(x = playClockCategory, y = yardsToGoBucket, fill = success_rate)) +
  geom_tile() +
  labs(
    title = "Success Rate Heatmap",
    x = "Play Clock Category",
    y = "Yards to Go Bucket",
    fill = "Success Rate"
  ) +
  theme_minimal() +
  scale_fill_gradient(low = "red", high = "green")
```
The heatmap above shows the success rate of plays based on whether the pass was 
complete (passResult == "C"), categorized by play clock and yards-to-go buckets. 
Notably, the highest success rate occurs when the play clock exceeds 15 seconds, 
especially in long-yardage situations (20 to 30 yards), where the success rate 
is over 70%. This suggests that more time on the play clock leads to better play 
execution, even when facing tougher distances.

Interestingly, short-yardage situations (0 to 10 yards) do not yield higher 
success rates. In fact, success rates in the [0, 5] and [5, 10] yard buckets 
are lower than longer-yardage plays, indicating that defensive anticipation may 
play a role. Additionally, when the play clock is less than 5 seconds, success 
rates drop across all yardage buckets. Overall, this heatmap shows a positive 
relationship between higher play clock times and play success, particularly in 
longer-yardage situations.

# Modeling

Here for the predictive model I used a multinomial regression model because the 
prediction outcome is nominal with multiple categories which is perfect for 
this kind of model. The code block below makes the model and puts the predicted 
probabilities of the model back into the filtered plays dataframe as its own 
column.
```{r}
library(nnet)

plays_filtered <- plays_filtered %>%
  mutate(
    playClockCategory = factor(playClockCategory),
    passResult = factor(passResult)
  ) |>
  filter(!is.na(passResult), !is.na(playClockAtSnap))

multinom_model <- multinom(passResult ~ playClockAtSnap, data = plays_filtered)

summary(multinom_model)

predictions <- predict(multinom_model, type = "probs")

nrow(plays_filtered)
nrow(predictions)
plays_filtered <- cbind(plays_filtered, predictions)
```

Here I plotted the predicted probabilities to visualize the model. As we can see,
as the play clock at snap increases, the probability of completing a pass also increases 
from the prediction of the model. This is reinforcing what we saw before on the 
exploratory data histogram of more completions when the play clock is higher. We 
can also see that the probabilities of the other categories are decreasing which is 
also parallel to what we saw before we fitted the model. Next we should discuss 
that this predictor may not be the best predictor and model for pass results due to
the low explanation of variance from the model.
```{r}
predicted_probs_df <- plays_filtered %>%
  select(playClockAtSnap, passResult, C, I, IN, R, S) %>%  
  pivot_longer(
    cols = C:S,  
    names_to = "Predicted_Class",
    values_to = "Probability"
  )

ggplot(predicted_probs_df, aes(x = playClockAtSnap, y = Probability, color = 
                                 Predicted_Class)) +
  geom_line(stat = "smooth", method = "loess") +
  labs(
    title = "Predicted Probabilities by Play Clock at Snap",
    x = "Play Clock at Snap",
    y = "Predicted Probability",
    color = "Pass Result"
  ) +
  theme_minimal()
```
Now, to evaluate the accuracy of the predicted classes from this model we look
at this confusion matrix. We see that the predicted class heavily favors
completed passes (which makes sense given that it has the highest probability
of occurring according to our model).

```{r}
# Get predicted classes from the model
predicted_classes <- predict(multinom_model, type = "class")

# Check distribution of predicted classes
table(predicted_classes)

# Compare with the actual distribution
table(plays_filtered$passResult)

```
Now we want to attempt to build a model that can help us find the optimal
play clock time at which to snap the ball given the yards left to go, the down,
the game clock and the offensive formation.

```{r}
#filter out relevant variables for model
plays_filtered2 <- plays_raw_data |>
  filter(!is.na(playClockAtSnap), !is.na(yardsToGo), !is.na(gameClock), !is.na(down))
```

Below, we've constructed a model that predicts the play clock at the time of
snap given the yards to go, the game clock time, the down and the offensive
formation.

```{r}
playClock_model <- lm(playClockAtSnap ~ yardsToGo + gameClock + down + offenseFormation, 
                      data = plays_filtered2)

summary(playClock_model)


```
Given the summary statistics, the model is statistically significant with an
overall p-value of $2.2 * 10^{-16}$. Additionally, every single variable we
used to predict the play clock at snap was statistically significant at at least
an alpha level of 0.05. It is also important to note that this model has an
adjusted R-squared of 0.05714, which tells us that the 5.7% of the variation
in the playClockAtSnap can be explained by this model. 

```{r}
# Fit a linear model
win_prob_model <- lm(expectedPointsAdded ~ playClockAtSnap + yardsToGo + down + 
                     gameClock + offenseFormation, 
                     data = plays_filtered2)

# Summarize the model
summary(win_prob_model)
```




```{r}

plays_filtered <- plays_filtered %>%
  mutate(success = ifelse(passResult == "C", 1, 0))

plays_filtered <- plays_filtered %>% filter(!is.na(success))

success_model <- multinom(
  passResult ~ playClockAtSnap + down + yardsToGo + passLength +
    pff_passCoverage + dropbackType,
  data = plays_filtered
)

summary(success_model)
```

```{r}
plays_filtered <- plays_filtered %>% filter(!is.na(success))

predictions <- predict(success_model, newdata = plays_filtered)

predicted_class <- ifelse(predictions > 0.5, 1, 0)

confusion_matrix <- confusionMatrix(as.factor(predictions), as.factor(plays_filtered$passResult))

print(confusion_matrix)
```

```{r}
library(pscl)

pseudo_r2 <- pR2(success_model)

print(pseudo_r2)
```
# Discussion







