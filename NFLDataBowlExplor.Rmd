---
title: "Play Clock Timing and the Play Outcomes in the NFL"
author: "Dominic Hoar-Weiler, Nathan Yao, and Justin Fung"
date: "January 6, 2025"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
geometry: a4paper
fontsize: 12pt
linestretch: 1.5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
#Click to clear environment
rm(list = ls())
```

#Introduction
One moment etched in the hearts of Minnesota Vikings fans is the 2018 NFL 
playoff game against the New Orleans Saints. With just 5 seconds left on the 
play clock, Case Keenum launches a high, spiraling pass to Stefon Diggs, who 
streaks down the right sideline. The crowd erupts as Diggs makes the catch and 
sprints into the end zone, completing one of the most iconic touchdowns in NFL 
history. This unforgettable play, now famously known as the Minneapolis Miracle, 
highlights the critical role of the play clock. In football, the play clock 
isn’t just a countdown, it’s a pressure cooker that influences decision making, 
timing, and ultimately, the outcome of a play.

I am doing to add the research question and a brief summary right here. 


#Importing Data

```{r}
# Increase memory size (Windows only)
memory.limit(size = 64000)  # Adjust as needed

library(tidyverse)
player_raw_data <- read_csv("players.csv")
plays_raw_data <- read_csv("plays.csv")
games_raw_data <- read_csv("games.csv")
# List all files matching the pattern "week" (e.g., "tracking_week_1.csv")
files <- list.files(pattern = "week", full.names = TRUE)
tracking_list <- list()

```
```{r}
for (file in files) {
  tracking <- read_csv(file)
  tracking <- tracking |>
    mutate(
    # make all plays go from left to right
    x = ifelse(playDirection == "left", 120 - x, x),
    y = ifelse(playDirection == "left", 160 / 3 - y, y),
    # flip player direction and orientation
    dir = ifelse(playDirection == "left", dir + 180, dir),
    dir = ifelse(dir > 360, dir - 360, dir),
    o = ifelse(playDirection == "left", o + 180, o),
    o = ifelse(o > 360, o - 360, o)
    )
  tracking_list[[file]] <- tracking
}
```

#Exploratory Analysis:

#Modeling

#Prediction

#Discussion

# Play Clock at Snap Exploration
  •	Topic: Predict play outcomes by the moment at which the ball is snapped
  each play
	•	Key Questions:
	  * What pre-snap factors have an influence on when the ball is snapped?
	  * How does the play clock at snap relate to play success?
	•	Deliverable: Conclusion about the importance of play clock at snap and how
	  teams should approach this piece of data


This is the most interesting find in my data. I categorized the playClockAtSnap 
into high, medium, and low. I then plotted the results of the different buckets 
to see the results. We can see that the lower the play clock, might have a 
higher likelihood of rushed plays and false starts. I was thinking that it could 
be correlated with poor play outcomes due to rushed decision making 
or how ready the defense is. On the other hand, I theorized that the higher play 
clock could be correlated with ready offenses while also potential catching
the defense off guard. We can see that when the playClock is less than or equal to 
5s, the results of the play are more spread out than than when the playClock is higher
indicating that results vary more.
```{r}
plays_raw_data <- plays_raw_data %>%
  mutate(playClockCategory = case_when(playClockAtSnap >= 15 ~ "playClock More Than 15s",               
      playClockAtSnap >= 5 & playClockAtSnap < 15 ~ "playClock Between 5s and 15s", 
      playClockAtSnap < 5 ~ "playClock Less Than 5s",               
    )
  )

plays_filtered <- plays_raw_data %>%
  filter(!is.na(passResult))

plays_filtered <- plays_raw_data %>%
  filter(!is.na(playClockCategory), !is.na(passResult))

ggplot(plays_filtered, aes(x = playClockCategory, fill = passResult)) +
  geom_bar(position = "fill") +
  labs(
    title = "Play Outcomes by Play Clock Category",
    x = "Play Clock Category",
    y = "Proportion",
    fill = "Pass Result"
  ) +
  theme_minimal()
```


We also investigated the relationship that the play block at snap might have
with the yards gained that play. However, as we can see in the below
visualization, there is no clear correlation between the two.

```{r}


ggplot(plays_filtered, aes(x = playClockCategory, y = yardsGained, fill = playClockCategory)) +
  geom_boxplot() +
  labs(
    title = "Yards Gained by Play Clock Category",
    x = "Play Clock Category",
    y = "Yards Gained"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

And we can see here, the playClock is indeed statistically significant with a
value of 0.0002549 < 0.05. The next step would be to find a model to potentially 
predict results.
```{r}
contingency_table <- table(plays_filtered$playClockCategory, plays_filtered$passResult)

chi_sq_test <- chisq.test(contingency_table)
print(chi_sq_test)
```
Here for the predictive model I used a multinomial regression model because the 
predictiction outcome is nominal with multiple categories which is perfect for this
kind of model. The codeblock below makes the model and puts the predicted probabilities
of the model back into the filtered plays dataframe as its own column.
```{r}
library(nnet)

plays_filtered <- plays_filtered %>%
  mutate(
    playClockCategory = factor(playClockCategory),
    passResult = factor(passResult)
  ) |>
  filter(!is.na(passResult), !is.na(playClockAtSnap))

multinom_model <- multinom(passResult ~ playClockAtSnap, data = plays_filtered)

summary(multinom_model)

predictions <- predict(multinom_model, type = "probs")

nrow(plays_filtered)
nrow(predictions)
plays_filtered <- cbind(plays_filtered, predictions)
```

Here I plotted the predicted probabilities to visualize the model. As we can see,
as the play clock at snap increases, the probability of completing a pass also increases 
from the prediction of the model. This is reinforcing what we saw before on the 
exploratory data histogram of more completions when the play clock is higher. We 
can also see that the probabilities of the other categories are decreasing which is 
also parallel to what we saw before we fitted the model. Next we should discuss 
that this predictor may not be the best predictor and model for pass results due to
the low explanation of variance from the model.
```{r}
predicted_probs_df <- plays_filtered %>%
  select(playClockAtSnap, passResult, C, I, IN, R, S) %>%  
  pivot_longer(
    cols = C:S,  
    names_to = "Predicted_Class",
    values_to = "Probability"
  )

ggplot(predicted_probs_df, aes(x = playClockAtSnap, y = Probability, color = Predicted_Class)) +
  geom_line(stat = "smooth", method = "loess") +
  labs(
    title = "Predicted Probabilities by Play Clock at Snap",
    x = "Play Clock at Snap",
    y = "Predicted Probability",
    color = "Pass Result"
  ) +
  theme_minimal()
```

#DON'T KNOW WHERE TO PUT THIS YET BUT ITS COOL

Further exploration of how the play clock affects other variables yields the
following heat map. This heat map illustrates the play success rate based on 
the play clock and yards to go during that play. 

```{r}
heatmap_data <- plays_filtered |>
  mutate(yardsToGoBucket = cut(yardsToGo, breaks = c(0, 5, 10, 15, 20, 30), right = FALSE)) |>
  group_by(playClockCategory, yardsToGoBucket) |>
  summarize(success_rate = mean(passResult == "C", na.rm = TRUE), .groups = "drop")

ggplot(heatmap_data, aes(x = playClockCategory, y = yardsToGoBucket, fill = success_rate)) +
  geom_tile() +
  labs(
    title = "Success Rate Heatmap",
    x = "Play Clock Bucket",
    y = "Yards to Go Bucket",
    fill = "Success Rate"
  ) +
  theme_minimal() +
  scale_fill_gradient(low = "red", high = "green")
```

