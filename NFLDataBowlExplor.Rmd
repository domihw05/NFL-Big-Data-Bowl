---
title: "NFL Data Bowl Practice"
author: "Dominic Hoar-Weiler"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Click to clear environment
rm(list = ls())
```

#Importing Data

```{r}
# Increase memory size (Windows only)
memory.limit(size = 64000)  # Adjust as needed

library(tidyverse)
player_raw_data <- read_csv("players.csv")
plays_raw_data <- read_csv("plays.csv")
games_raw_data <- read_csv("games.csv")
tracking_week_1 <- read_csv("tracking_week_1.csv")
#putting all the tracking data into one file
#tracking <- list.files(pattern = "week") |> 
 # map(read_csv) |> 
  #list_rbind()
```
```{r}
#tracking <- tracking |>
  #mutate(
    # make all plays go from left to right
   # x = ifelse(playDirection == "left", 120 - x, x),
  #  y = ifelse(playDirection == "left", 160 / 3 - y, y),
    # flip player direction and orientation
   # dir = ifelse(playDirection == "left", dir + 180, dir),
   # dir = ifelse(dir > 360, dir - 360, dir),
  #  o = ifelse(playDirection == "left", o + 180, o),
 #   o = ifelse(o > 360, o - 360, o)
#  )
tracking_week_1 <- tracking_week_1 |>
  mutate(
    # make all plays go from left to right
    x = ifelse(playDirection == "left", 120 - x, x),
    y = ifelse(playDirection == "left", 160 / 3 - y, y),
    # flip player direction and orientation
    dir = ifelse(playDirection == "left", dir + 180, dir),
    dir = ifelse(dir > 360, dir - 360, dir),
    o = ifelse(playDirection == "left", o + 180, o),
    o = ifelse(o > 360, o - 360, o)
  )
```

#Exploring the Data

#Nathan's Work

```{r}
#Testing quantitative variables: down, yardsToGo, offensiveFormation, recieverAlignment 
# Drop rows with missing values in key columns
plays_clean <- plays_raw_data |>
  filter(
    !is.na(yardsGained),           
    !is.na(down),                 
    !is.na(yardsToGo),            
    !is.na(receiverAlignment)   
  )

# Linear regression with pre-snap variables
model_pre_snap <- lm(yardsGained ~ yardlineSide + down + yardsToGo, data = plays_clean)

# Summary of the model
summary(model_pre_snap)
```
```{r}
#cleaning for offensiveFormation for ANOVA test 
plays_clean <- plays_clean |>
  filter(offenseFormation != "EMPTY")

# Boxplot after cleaning
plays_clean |>
  ggplot(aes(x = offenseFormation, y = yardsGained)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Yards Gained by Offensive Formation (Excluding EMPTY)",
    x = "Offensive Formation",
    y = "Yards Gained"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ANOVA after cleaning
anova_model <- aov(yardsGained ~ offenseFormation, data = plays_clean)
summary(anova_model)

TukeyHSD(anova_model) #trying to see which ones difer the most


# Calculate mean yards gained by formation
formation_means <- plays_clean |>
  group_by(offenseFormation) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    count = n()
  ) |>
  arrange(desc(mean_yards)) 

formation_means

# Bar plot of mean yards gained by formation
formation_means |>
  ggplot(aes(x = reorder(offenseFormation, mean_yards), y = mean_yards)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    title = "Mean Yards Gained by Offensive Formation",
    x = "Offensive Formation",
    y = "Mean Yards Gained"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
# Group by receiver alignment and calculate mean yards gained
alignment_stats <- plays_clean |>
  group_by(receiverAlignment) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    count = n()
  ) |>
  arrange(desc(mean_yards))

# View the summary stats
alignment_stats

# Boxplot for yards gained by receiver alignment
plays_clean |>
  ggplot(aes(x = receiverAlignment, y = yardsGained)) +
  geom_boxplot() +
  labs(
    title = "Impact of Receiver Alignment on Yards Gained",
    x = "Receiver Alignment",
    y = "Yards Gained"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ANOVA test for receiver alignment
anova_alignment <- aov(yardsGained ~ receiverAlignment, data = plays_clean)
summary(anova_alignment)


```
```{r}
tukey_alignment <- TukeyHSD(anova_alignment)
tukey_alignment
```
Defense formation
```{r}
# Filter out rows with missing values in pass coverage or man/zone
plays_clean <- plays_clean |>
  filter(!is.na(pff_passCoverage), !is.na(pff_manZone), !is.na(yardsGained))

# Linear regression with pass coverage
model_pass_coverage <- lm(yardsGained ~ pff_passCoverage, data = plays_clean)
summary(model_pass_coverage)

# Linear regression with man/zone coverage
model_manzone <- lm(yardsGained ~ pff_manZone, data = plays_clean)
summary(model_manzone)

# Linear regression with interaction terms
model_interaction <- lm(yardsGained ~ pff_passCoverage * pff_manZone, data = plays_clean)
summary(model_interaction)

```
```{r}
#trying to see which one(s) are different 
anova_pass <- aov(yardsGained ~ pff_passCoverage, data = plays_clean)
summary(anova_pass)

anova_manzone <- aov(yardsGained ~ pff_manZone, data = plays_clean)
summary(anova_manzone)

# Tukey's HSD for man/zone coverage
tukey_manzone <- TukeyHSD(anova_manzone)
tukey_manzone
```
```{r}
# Tukey's HSD for pass coverage
tukey_pass <- TukeyHSD(anova_pass)
tukey_pass
```

#exploring pre snap movement
```{r}
# Detect lateral pre-snap movement
motion_data <- tracking |>
  filter(frameType == "BEFORE_SNAP") |>  # Pre-snap frames only
  group_by(gameId, playId, nflId) |>
  mutate(y_diff = abs(y - lag(y, default = first(y)))) |>  # Change in Y-position
  summarize(max_y_diff = max(y_diff, na.rm = TRUE)) |>    # Max movement per player
  ungroup()

# Flag motion if max Y movement exceeds threshold (e.g., 1 yard)
motion_flag <- motion_data |>
  group_by(gameId, playId) |>
  summarize(motion_detected = any(max_y_diff > 1))  # True if any player moved > 1 yard

# Merge motion detection flag with play outcomes
plays_clean <- plays_raw_data |>
  left_join(motion_flag, by = c("gameId", "playId")) |>
  mutate(motion_detected = ifelse(is.na(motion_detected), FALSE, motion_detected))

# Compare yards gained with and without motion
motion_summary <- plays_clean |>
  group_by(motion_detected) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    success_rate = mean(yardsGained >= 5, na.rm = TRUE),
    play_count = n()
  )

print(motion_summary)

```
```{r}
library(dplyr)
library(ggplot2)

# Calculate maximum Y-movement for each player before the snap
movement_data <- tracking |>
  filter(frameType == "BEFORE_SNAP") |>
  group_by(gameId, playId, nflId) |>
  mutate(y_diff = abs(y - lag(y, default = first(y)))) |>  # Change in Y position
  summarize(max_y_diff = max(y_diff, na.rm = TRUE)) |>
  ungroup()

# View summary statistics
summary(movement_data$max_y_diff)

```

```{r}
ggplot(movement_data, aes(x = max_y_diff)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Pre-Snap Y-Movement",
    x = "Max Y-Movement (yards)",
    y = "Frequency"
  ) +
  theme_minimal()

```

```{r}
t_test_result <- t.test(yardsGained ~ motion_detected, data = plays_clean)
print(t_test_result)

```
#Recievers only
```{r}
# Merge tracking data with player positions
tracking_receivers <- tracking |>
  left_join(player_raw_data, by = "nflId") |>   # Match player IDs to get their position
  filter(position %in% c("WR", "TE", "RB"))  # Keep only receivers
```

```{r}
# Detect pre-snap movement for receivers only
motion_data_receivers <- tracking_receivers |>
  filter(frameType == "BEFORE_SNAP") |>
  group_by(gameId, playId, nflId) |>
  mutate(y_diff = abs(y - lag(y, default = first(y)))) |>
  summarize(max_y_diff = max(y_diff, na.rm = TRUE)) |>
  group_by(gameId, playId) |>
  summarize(receiver_motion = any(max_y_diff > 1))  # Threshold: >1 yard
```
```{r}
# Merge receiver motion with play outcomes
plays_clean <- plays_raw_data |>
  left_join(motion_data_receivers, by = c("gameId", "playId")) |>
  mutate(receiver_motion = ifelse(is.na(receiver_motion), FALSE, receiver_motion))

# Summarize offensive success with and without receiver motion
motion_summary <- plays_clean |>
  group_by(receiver_motion) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    success_rate = mean(yardsGained >= 5, na.rm = TRUE),  # Success: 5+ yards gained
    play_count = n()
  )

print(motion_summary)

# Perform t-test
t_test_result <- t.test(yardsGained ~ receiver_motion, data = plays_clean)
print(t_test_result)
```

```{r}
library(dplyr)

# Detect pre-snap movement using both X and Y values
receiver_movement <- tracking_receivers |>
  filter(frameType == "BEFORE_SNAP") |>
  group_by(gameId, playId, nflId) |>
  mutate(
    movement = sqrt((x - lag(x, default = first(x)))^2 + (y - lag(y, default = first(y)))^2)
  ) |>
  summarize(
    total_movement = sum(movement, na.rm = TRUE)  # Total movement across frames
  ) |>
  ungroup()

# View summary
summary(receiver_movement$total_movement)
```
```{r}
library(ggplot2)

# Histogram to explore movement distribution
ggplot(receiver_movement, aes(x = total_movement)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Total Pre-Snap Movement (X and Y)",
    x = "Total Movement (yards)",
    y = "Frequency"
  ) +
  theme_minimal()

# Threshold at 95th percentile
threshold <- quantile(receiver_movement$total_movement, 0.95, na.rm = TRUE)
print(threshold)

# Flag plays with significant receiver motion
motion_flag_combined <- receiver_movement |>
  group_by(gameId, playId) |>
  summarize(receiver_motion = any(total_movement > threshold))  # Flag motion

# Merge motion flag with play outcomes
plays_with_motion <- plays_raw_data |>
  left_join(motion_flag_combined, by = c("gameId", "playId")) |>
  mutate(receiver_motion = ifelse(is.na(receiver_motion), FALSE, receiver_motion))

# Compare outcomes with and without motion
motion_summary_combined <- plays_with_motion |>
  group_by(receiver_motion) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    success_rate = mean(yardsGained >= 5, na.rm = TRUE),
    play_count = n()
  )

print(motion_summary_combined)

# Perform t-test for yards gained
t_test_result_combined <- t.test(yardsGained ~ receiver_motion, data = plays_with_motion)
print(t_test_result_combined)

# Linear regression with interaction term
model_combined <- lm(yardsGained ~ receiver_motion * offenseFormation, data = plays_with_motion)

# View model summary
summary(model_combined)
```
#presnap movement and penalties
```{r}
library(dplyr)
library(stringr)

# Identify pre-snap penalties in playDescription
penalty_plays <- plays_raw_data |>
  mutate(
    penalty_flag = str_detect(playDescription, regex("penalty", ignore_case = TRUE))
  )

# Filter only penalty plays
pre_snap_penalties <- penalty_plays |>
  filter(penalty_flag == TRUE)

# View summary of penalties
print(nrow(pre_snap_penalties))  # Total number of penalty plays

```
```{r}
# Calculate total movement for each player BEFORE_SNAP
movement_data <- tracking |>
  filter(frameType == "BEFORE_SNAP") |>
  group_by(gameId, playId, nflId) |>
  summarize(
    total_movement = sum(sqrt((x - lag(x, default = first(x)))^2 + (y - lag(y, default = first(y)))^2), na.rm = TRUE),
    .groups = "drop"  # Explicitly drop grouping
  )

# Merge movement with penalty data
penalty_movement <- movement_data |>
  left_join(pre_snap_penalties, by = c("gameId", "playId")) |>
  mutate(penalty = ifelse(!is.na(penalty_flag), "Penalty", "No Penalty"))

# Compare movement between penalty and non-penalty plays
movement_summary <- penalty_movement |>
  group_by(penalty) |>
  summarize(
    mean_movement = mean(total_movement, na.rm = TRUE),
    play_count = n()
  )

print(movement_summary)
```
```{r}
# Compare yards gained for plays with and without penalties
penalty_outcome <- penalty_plays |>
  mutate(penalty_flag = ifelse(penalty_flag, "Penalty", "No Penalty")) |>
  group_by(penalty_flag) |>
  summarize(
    mean_yards = mean(yardsGained, na.rm = TRUE),
    success_rate = mean(yardsGained >= 5, na.rm = TRUE),  # Success: gain >= 5 yards
    play_count = n()
  )

print(penalty_outcome)
```

```{r}
t_test_result <- t.test(yardsGained ~ penalty_flag, data = penalty_plays)
print(t_test_result)
```

```{r}

library(ggplot2)
ggplot(penalty_plays, aes(x = as.factor(penalty_flag), y = yardsGained, fill = penalty_flag)) +
  geom_boxplot() +
  labs(
    title = "Effect of Pre-Snap Penalties on Yards Gained",
    x = "Penalty Flag (TRUE/FALSE)",
    y = "Yards Gained"
  ) +
  theme_minimal()
```

# Pre-Snap Blitz Detection
	•	Topic: Predict defensive blitzes based on pre-snap player positioning and 
	movement.
	•	Key Questions:
	•	What pre-snap defensive alignments or movements are the best indicators of 
	a blitz?
	•	How does successful blitz detection affect QB performance and play outcomes?
	•	Deliverable: A machine learning model to predict blitz likelihood and its 
	relationship with play success.
	
One question we have to answer is how do we identify blitzes? The common 
definition of a blitz is when the defense sends more than the usual amount of 
defenders to rush the quarterback. The three types of blitzes are corner 
blitzes, safety blitzes and linebacker blitzes. These types simply identify 
what positions are sent to blitz.

Below, I'm attempting to trim the tracking data, and then add columns so that
we can measure whether players are rushing or not, so that we can then set
a threshold of number of rushers, to identify if plays are blitzes or not.
	
```{r}
dom_mov_data <- tracking_week_1 |>
  group_by(gameId, playId, nflId) |>
  left_join(player_raw_data, by = c("nflId"))

tracking_qb <- dom_mov_data |>
  filter(position == "QB") |>
  select(gameId, playId, frameId, x_qb = x, y_qb = y)

movement_data <- dom_mov_data |>
  filter(frameType == "BEFORE_SNAP") |>
  group_by(gameId, playId, nflId) |>
  summarize(
    total_movement = sum(sqrt((x - lag(x, default = first(x)))^2 + (y - lag(y, default = first(y)))^2), na.rm = TRUE),
    .groups = "drop"  # Explicitly drop grouping
  )

tracking_pass_rush <- dom_mov_data |>
  filter(position %in% c("SS","FS","CB","ILB","OLB")) |>
  left_join(tracking_qb, by = c("gameId","playId","frameId")) |>
  group_by(gameId, playId, frameId) |>
  mutate(d_qb = sqrt((x - x_qb) ^ 2 + (y - y_qb) ^ 2),
         v_qb = -(d_qb - lag(d_qb)) / 0.1) |>
  ungroup() |>
  left_join(movement_data, by = c("gameId","playId","nflId.x" = "nflId"))

tracking_pass_rush <- tracking_pass_rush |>
  select(gameId,playId,frameId,nflId.x,displayName.x,frameType,time,playDirection,
         x,y,s,a,dis,o,dir,event,position,x_qb,y_qb,d_qb,v_qb,total_movement) |>
   mutate(blitzing = ifelse((dir > 180 | d_qb < 8) & v_qb > 5 & frameType ==      "AFTER_SNAP",TRUE,FALSE))

# Remove rows with NA values in blitzing
tracking_pass_rush_clean <- tracking_pass_rush |>
  left_join(plays_raw_data |> select(gameId, playId, offenseFormation, playClockAtSnap, pff_passCoverage,down,yardsToGo), by = c("gameId", "playId")) |>
  mutate(motion_flag = ifelse(total_movement > 3, 1, 0)) |>
  filter(
    !is.na(blitzing),
    !is.na(total_movement),
    !is.na(offenseFormation),
    !is.na(playClockAtSnap)
  )
```

Now that we've filtered the data accordingly, let's create the models.

```{r}
# Check updated data
head(tracking_pass_rush_clean)

# Create model
predicting_blitz.blogr <- glm(blitzing ~ total_movement + offenseFormation + playClockAtSnap, 
                              data = tracking_pass_rush_clean, 
                              family = binomial(link = "logit"))

predicted_probs <- predict(predicting_blitz.blogr, type = "response")

predicting_blitz <- glm(blitzing ~ total_movement + 
                                  offenseFormation + 
                                  down + yardsToGo + 
                                  motion_flag + 
                                  d_qb,
                        family = binomial(link = "logit"),
                        data = tracking_pass_rush_clean)

# Test if the data are logistic
library(ResourceSelection)
hoslem.test(tracking_pass_rush_clean$blitzing,predicted_probs)
```

Since the Hosmer and Lemeshow goodness of fit test yielded a p-value of
$2.2 * 10^{-6}$. This means that we reject the null hypothesis that the data are 
reasonably logistic. This means that the logistic model is likely not a good
fit for the data.

That being said, let's proceed anyway to see what we can find.

```{r}
# Summarize both models
summary(predicting_blitz.blogr)
summary(predicting_blitz)
# Found correlation between pre-snap movement and whether or not that player blitzed
```

Based on the above information, we have that it is possible that there is a 
relationship between total pre-snap movement of a player and whether they blitz
or not. Also, by running the Hosmer and Lemeshow test, we found that the data 
are not reasonably logistic, meaning the resulting data from the binary 
logistic regression model is unreliable.

#Nathan's work for blitz detection

